module("users.timfelgentreff.deltablue.deltablue").requires().toRun(function(){Object.subclass("DBOrderedCollection",{initialize:function(){this.elms=new Array},add:function(elm){this.elms.push(elm)},at:function(index){return this.elms[index]},size:function(){return this.elms.length},removeFirst:function(){return this.elms.pop()},remove:function(elm){for(var index=0,skipped=0,i=0;i<this.elms.length;i++){var value=this.elms[i];value!=elm?(this.elms[index]=value,index++):skipped++}for(var i=0;skipped>i;i++)this.elms.pop()}}),Object.subclass("DBStrength",{initialize:function(strengthValue,name){this.strengthValue=strengthValue,this.name=name},nextWeaker:function(){switch(this.strengthValue){case 0:return DBStrength.WEAKEST;case 1:return DBStrength.WEAK_DEFAULT;case 2:return DBStrength.NORMAL;case 3:return DBStrength.STRONG_DEFAULT;case 4:return DBStrength.PREFERRED;case 5:return DBStrength.REQUIRED}}}),Object.extend(DBStrength,{stronger:function(s1,s2){return s1.strengthValue<s2.strengthValue},weaker:function(s1,s2){return s1.strengthValue>s2.strengthValue},weakestOf:function(s1,s2){return this.weaker(s1,s2)?s1:s2},strongest:function(s1,s2){return this.stronger(s1,s2)?s1:s2},REQUIRED:new DBStrength(0,"required"),STONG_PREFERRED:new DBStrength(1,"strongPreferred"),PREFERRED:new DBStrength(2,"preferred"),STRONG_DEFAULT:new DBStrength(3,"strongDefault"),NORMAL:new DBStrength(4,"normal"),WEAK_DEFAULT:new DBStrength(5,"weakDefault"),WEAKEST:new DBStrength(6,"weakest")}),Object.subclass("DBConstraint",{initialize:function(strength,planner){this.planner=planner,this.strength=strength},addDBConstraint:function(){this.addToGraph(),this.planner.incrementalAdd(this)},satisfy:function(mark){if(this.chooseMethod(mark),!this.isSatisfied())return this.strength==DBStrength.REQUIRED,null;this.markInputs(mark);var out=this.output(),overridden=out.determinedBy;return null!=overridden&&overridden.markUnsatisfied(),out.determinedBy=this,this.planner.addPropagate(this,mark)||alert("Cycle encountered"),out.mark=mark,overridden},destroyDBConstraint:function(){this.isSatisfied()?this.planner.incrementalRemove(this):this.removeFromGraph()},isInput:function(){return!1}}),DBConstraint.subclass("UnaryDBConstraint",{initialize:function($super,v,strength,planner){$super(strength,planner),this.myOutput=v,this.satisfied=!1},addToGraph:function(){this.myOutput.addDBConstraint(this),this.satisfied=!1},chooseMethod:function(mark){this.satisfied=this.myOutput.mark!=mark&&DBStrength.stronger(this.strength,this.myOutput.walkDBStrength)},isSatisfied:function(){return this.satisfied},markInputs:function(){},output:function(){return this.myOutput},recalculate:function(){this.myOutput.walkDBStrength=this.strength,this.myOutput.stay=!this.isInput(),this.myOutput.stay&&this.execute()},markUnsatisfied:function(){this.satisfied=!1},inputsKnown:function(){return!0},removeFromGraph:function(){null!=this.myOutput&&this.myOutput.removeDBConstraint(this),this.satisfied=!1}}),UnaryDBConstraint.subclass("StayDBConstraint",{execute:function(){}}),UnaryDBConstraint.subclass("EditDBConstraint",{isInput:function(){return!0},execute:function(){}});var Direction=new Object;Direction.NONE=0,Direction.FORWARD=1,Direction.BACKWARD=-1,DBConstraint.subclass("BinaryDBConstraint",{initialize:function($super,var1,var2,strength,planner){$super(strength,planner),this.v1=var1,this.v2=var2,this.direction=Direction.NONE},chooseMethod:function(mark){this.v1.mark==mark&&(this.direction=this.v2.mark!=mark&&DBStrength.stronger(this.strength,this.v2.walkDBStrength)?Direction.FORWARD:Direction.NONE),this.v2.mark==mark&&(this.direction=this.v1.mark!=mark&&DBStrength.stronger(this.strength,this.v1.walkDBStrength)?Direction.BACKWARD:Direction.NONE),this.direction=DBStrength.weaker(this.v1.walkDBStrength,this.v2.walkDBStrength)?DBStrength.stronger(this.strength,this.v1.walkDBStrength)?Direction.BACKWARD:Direction.NONE:DBStrength.stronger(this.strength,this.v2.walkDBStrength)?Direction.FORWARD:Direction.BACKWARD},addToGraph:function(){this.v1.addDBConstraint(this),this.v2.addDBConstraint(this),this.direction=Direction.NONE},isSatisfied:function(){return this.direction!=Direction.NONE},markInputs:function(mark){this.input().mark=mark},input:function(){return this.direction==Direction.FORWARD?this.v1:this.v2},output:function(){return this.direction==Direction.FORWARD?this.v2:this.v1},recalculate:function(){var ihn=this.input(),out=this.output();out.walkDBStrength=DBStrength.weakestOf(this.strength,ihn.walkDBStrength),out.stay=ihn.stay,out.stay&&this.execute()},markUnsatisfied:function(){this.direction=Direction.NONE},inputsKnown:function(mark){var i=this.input();return i.mark==mark||i.stay||null==i.determinedBy},removeFromGraph:function(){null!=this.v1&&this.v1.removeDBConstraint(this),null!=this.v2&&this.v2.removeDBConstraint(this),this.direction=Direction.NONE}}),DBConstraint.subclass("UserDBConstraint",{initialize:function($super,strengthOrPredicateOrFormulas,predicateOrFormulasOrPlanner,formulasOrPlanner,planner){var strength,formulas,predicate;planner?(strength=strengthOrPredicateOrFormulas,predicate=predicateOrFormulasOrPlanner,formulas=formulasOrPlanner):formulasOrPlanner?"function"==typeof formulasOrPlanner?(strength=strengthOrPredicateOrFormulas,predicate=predicateOrFormulasOrPlanner,formulas=formulasOrPlanner):(planner=formulasOrPlanner,"function"==typeof strengthOrPredicateOrFormulas?(predicate=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner):(strength=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner)):predicateOrFormulasOrPlanner?"function"==typeof strengthOrPredicateOrFormulas?"function"==typeof predicateOrFormulasOrPlanner?(predicate=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner):(formulas=strengthOrPredicateOrFormulas,planner=predicateOrFormulasOrPlanner):(strength=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner):formulas=strengthOrPredicateOrFormulas,strength=strength||DBStrength.required,$super(strength,planner),this.predicate=predicate,this.formulas=[],this.outputs=[],this.inputs=[],this.satisfied=!1,formulas(this)},formula:function(output,inputs,func){if(inputs.include(output))throw"output cannot be determined by itself";var idx=this.outputs.indexOf(output),len=this.outputs.length;if(idx>=0)throw"multiple formulas for "+output;this.outputs.push(output),inputs.each(function(input){this.inputs.include(input)||this.inputs.push(input)}.bind(this)),this.formulas[len]={inputs:inputs,func:func}},chooseMethod:function(mark){var weakest_output=null,weakest_strength=this.strength;this.outputs.each(function(out){out.mark!=mark&&DBStrength.stronger(weakest_strength,out.walkDBStrength)&&(weakest_strength=out.walkDBStrength,weakest_output=out)}.bind(this)),this.out=weakest_output,this.satisfied=!!this.out},addToGraph:function(){var that=this;this.variables.each(function(ea){ea.addDBConstraint(that)}),this.satisfied=!1},isSatisfied:function(){return this.satisfied},markInputs:function(mark){var out=this.out;this.inputs.each(function(ea){ea!==out&&(ea.mark=mark)})},recalculate:function(){var out=this.out;out.walkDBStrength=this.strength,this.inputs.each(function(ea){out.walkDBStrength=DBStrength.weakestOf(out.walkDBStrength,ea.walkDBStrength)}),out.stay=this.inputs.all(function(ea){return ea.stay}),out.stay&&this.execute()},markUnsatisfied:function(){this.satisfied=!1},inputsKnown:function(mark){var out=this.out;return this.inputs.all(function(i){return i===out||i.mark==mark||i.stay||null==i.determinedBy})},removeFromGraph:function(){var that=this;this.variables.each(function(ea){ea.removeDBConstraint(that)}),this.satisfied=!1},execute:function(){if(!this.predicate||!this.predicate()){var formula=this.formulas[this.outputs.indexOf(this.out)],func=formula.func,inputs=formula.inputs;this.out.value=func.apply(null,inputs.collect(function(ea){return ea.value}).concat([this.out.value]))}},output:function(){return this.out},get variables(){return this.outputs.concat(this.inputs).uniq()}}),BinaryDBConstraint.subclass("ScaleDBConstraint",{initialize:function($super,src,scale,offset,dest,strength,planner){this.direction=Direction.NONE,this.scale=scale,this.offset=offset,$super(src,dest,strength,planner)},addToGraph:function($super){$super(),this.scale.addDBConstraint(this),this.offset.addDBConstraint(this)},removeFromGraph:function($super){$super(),null!=this.scale&&this.scale.removeDBConstraint(this),null!=this.offset&&this.offset.removeDBConstraint(this)},markInputs:function($super,mark){$super(mark),this.scale.mark=this.offset.mark=mark},execute:function(){this.direction==Direction.FORWARD?this.v2.value=this.v1.value*this.scale.value+this.offset.value:this.v1.value=(this.v2.value-this.offset.value)/this.scale.value},recalculate:function(){var ihn=this.input(),out=this.output();out.walkDBStrength=DBStrength.weakestOf(this.strength,ihn.walkDBStrength),out.stay=ihn.stay&&this.scale.stay&&this.offset.stay,out.stay&&this.execute()}}),BinaryDBConstraint.subclass("EqualityDBConstraint",{execute:function(){this.output().value=this.input().value}}),Object.subclass("DBVariable",{initialize:function(name,initialValue,planner){this.planner=planner,this.value=initialValue,this.constraints=new DBOrderedCollection,this.determinedBy=null,this.mark=0,this.walkDBStrength=DBStrength.WEAKEST,this.stay=!0,this.name=name},addDBConstraint:function(c){this.constraints.add(c)},removeDBConstraint:function(c){this.constraints.remove(c),this.determinedBy==c&&(this.determinedBy=null)},assignValue:function(newValue){var edit=new EditDBConstraint(this,DBStrength.REQUIRED,this.planner),edits=new DBOrderedCollection;edit.addDBConstraint(),edits.add(edit);var plan=this.planner.extractDBPlanFromDBConstraints(edits);this.value=newValue;try{plan.execute()}finally{edit.destroyDBConstraint()}}}),Object.subclass("DBPlanner",{initialize:function(){this.currentMark=0},incrementalAdd:function(c){for(var mark=this.newMark(),overridden=c.satisfy(mark);null!=overridden;)overridden=overridden.satisfy(mark)},incrementalRemove:function(c){var out=c.output();c.markUnsatisfied(),c.removeFromGraph();var unsatisfied=this.removePropagateFrom(out),strength=DBStrength.REQUIRED;do{for(var i=0;i<unsatisfied.size();i++){var u=unsatisfied.at(i);u.strength==strength&&this.incrementalAdd(u)}strength=strength.nextWeaker()}while(strength!=DBStrength.WEAKEST)},newMark:function(){return++this.currentMark},makeDBPlan:function(sources){for(var mark=this.newMark(),plan=new DBPlan,todo=sources;todo.size()>0;){var c=todo.removeFirst();c.output().mark!=mark&&c.inputsKnown(mark)&&(plan.addDBConstraint(c),c.output().mark=mark,this.addDBConstraintsConsumingTo(c.output(),todo,c))}return plan},extractDBPlanFromDBConstraints:function(constraints){for(var sources=new DBOrderedCollection,i=0;i<constraints.size();i++){var c=constraints.at(i);c.isInput()&&c.isSatisfied()&&sources.add(c)}return this.makeDBPlan(sources)},addPropagate:function(c,mark){var todo=new DBOrderedCollection;for(todo.add(c);todo.size()>0;){var d=todo.removeFirst();if(d.output().mark==mark)return this.incrementalRemove(c),!1;d.recalculate(),this.addDBConstraintsConsumingTo(d.output(),todo)}return!0},removePropagateFrom:function(out){out.determinedBy=null,out.walkDBStrength=DBStrength.WEAKEST,out.stay=!0;var unsatisfied=new DBOrderedCollection,todo=new DBOrderedCollection;for(todo.add(out);todo.size()>0;){for(var v=todo.removeFirst(),i=0;i<v.constraints.size();i++){var c=v.constraints.at(i);c.isSatisfied()||unsatisfied.add(c)}for(var determining=v.determinedBy,i=0;i<v.constraints.size();i++){var next=v.constraints.at(i);next!=determining&&next.isSatisfied()&&(next.recalculate(),todo.add(next.output()))}}return unsatisfied},addDBConstraintsConsumingTo:function(v,coll,not){for(var determining=v.determinedBy,cc=v.constraints,i=0;i<cc.size();i++){var c=cc.at(i);c!=determining&&c.isSatisfied()&&c!=not&&coll.add(c)}}}),Object.subclass("DBPlan",{initialize:function(){this.v=new DBOrderedCollection},addDBConstraint:function(c){this.v.add(c)},size:function(){return this.v.size()},constraintAt:function(index){return this.v.at(index)},execute:function(){for(var i=0;i<this.size();i++){var c=this.constraintAt(i);c.execute()}}})}),module("users.timfelgentreff.babelsberg.deltablue_ext").requires("users.timfelgentreff.deltablue.deltablue","users.timfelgentreff.jsinterpreter.Interpreter").toRun(function(){DBPlanner.addMethods({isConstraintObject:!0,constraintVariableFor:function(value,ivarname){return new DBVariable(ivarname,value,this)},get strength(){return DBStrength},always:function(opts,func){Object.isString(opts.priority)&&(opts.priority=this.strength[opts.priority]),func.allowUnsolvableOperations=!0;var planner=this,ctx=opts.ctx,priority=opts.priority,methods=opts.methods;func.varMapping=ctx,methods||(methods=func,func=void 0),methods.varMapping=ctx;var cobj=new Constraint(methods,planner),formulas=cobj.constraintvariables.collect(function(v){var v=v.externalVariables(planner);return v?v.removeFormula():null}).compact();if(formulas.length>0){var constraint=new UserDBConstraint(priority,func,function(c){formulas.each(function(m){var inputs=m.inputs.select(function(input){return input instanceof DBVariable});dbgOn(inputs.length!==m.inputs.length),c.formula(m.output,inputs,m.func)})},planner);cobj.addPrimitiveConstraint(constraint)}return cobj.priority=priority,cobj},weight:100,addEditVar:function(v){this.currentEdits||(this.currentEdits=new DBOrderedCollection);var edit=new EditDBConstraint(v,DBStrength.required,this);return this.currentEdits.add(edit),edit},solve:function(){},beginEdit:function(){if(this.currentEditPlan)throw"Trying to run nested edits - this isn't supported";if(!this.currentEdits)throw"No edit variables - cannot beginEdit";this.currentEditPlan=this.extractDBPlanFromDBConstraints(this.currentEdits)},endEdit:function(){this.currentEdits&&0!==this.currentEdits.length&&this.currentEdits.elms.each(function(edit){edit.destroyDBConstraint()}),this.currentEditPlan=null},resolveArray:function(newValues){if(!this.currentEdits)throw"resolveArray only valid in edit";this.currentEdits.elms.each(function(edit,idx){edit.myOutput.value=newValues[idx]}),this.currentEditPlan.execute()}}),Object.extend(DBPlanner,{getInstance:function(){return this.$$instance||(this.$$instance=new DBPlanner),this.$$instance},resetInstance:function(){this.$$instance=void 0}}),Object.extend(DBStrength,{required:DBStrength.REQUIRED,strong:DBStrength.STRONG_DEFAULT,medium:DBStrength.NORMAL,weak:DBStrength.WEAK_DEFAULT}),DBVariable.addMethods({isConstraintObject:!0,stay:function(strength){var cn=new StayDBConstraint(this,strength||DBStrength.WEAK_DEFAULT,this.planner);return cn.enable(),this._stayConstraint=cn,cn},setReadonly:function(bool){if(bool&&!this.readonlyConstraint){var cn=new StayDBConstraint(this,DBStrength.STONG_PREFERRED,this.planner);return cn.enable(),this.readonlyConstraint=cn,cn}!bool&&this.readonlyConstraint&&(this.readonlyConstraint.disable(),this.readonlyConstraint=void 0)},isReadonly:function(){return!!this.readonlyConstraint},formula:function(inputs,func){if(console.warn("Deprecated: Using DBVariable>>formula"),!Constraint.current)throw"invalid outside constraint construction";if(this.__formula__)throw"two formulas for the same variable "+this;this.__formula__={output:this,inputs:inputs,func:func}},removeFormula:function(){var f=this.__formula__;return this.__formula__=void 0,f},removeStay:function(){if(this._stayConstraint)try{this.planner.removeConstraint(this._stayConstraint)}catch(_){this._stayConstraint=null}},suggestValue:function(value){this.assignValue(value)},prepareEdit:function(){this.editConstraint||(this.editConstraint=this.planner.addEditVar(this))},finishEdit:function(){this.editConstraint=null},cnIdentical:function(other){if(!(other instanceof DBVariable)){other=new DBVariable("constant/"+other,other,this.planner);var stay=new StayDBConstraint(other,DBStrength.required,this.planner);stay.enable(DBStrength.required)}return new EqualityDBConstraint(this,other,DBStrength.required,Constraint.current.solver)},cnEquals:function(other){if(!(other instanceof DBVariable)){var formulaNode=bbb.currentNode&&("=="===bbb.currentNode.name||bbb.currentNode.property&&"equals"===bbb.currentNode.property.value)&&(bbb.currentNode.right||bbb.currentNode.args[0]);if(formulaNode){var self=this,argumentString=cop.withLayers([PrintOMetaVariableAsBBBField],function(){return formulaNode.asJS()}),varMapping=bbb.currentInterpreter.getCurrentScope(),func=function(){window.$$bbbVarMapping=varMapping;try{return eval(argumentString)}finally{delete window.$$bbbVarMapping}},inputs=Constraint.current.constraintvariables.map(function(cvar){return cvar.externalVariable}).filter(function(evar){return evar&&evar!==this&&"string"==typeof evar.name}.bind(this)),c=new UserDBConstraint(function(){},Constraint.current.solver);return c.formula(this,inputs,func),c}other=new DBVariable("constant/"+other,other,this.planner),Constraint.current.addPrimitiveConstraint(new StayDBConstraint(other,DBStrength.required,this.planner))}var self=this;return cloneFunc=function(fromObj){return fromObj.clone?fromObj.clone():fromObj.copy?fromObj.copy():fromObj},new UserDBConstraint(function(c){c.formula(self,[other],cloneFunc),c.formula(other,[self],cloneFunc)},Constraint.current.solver)},cnOr:function(other){return this.value?this:other},equals:function(){return this.cnEquals.apply(this,arguments)}}),UserDBConstraint.addMethods({cnAnd:function(r){if(r instanceof UserDBConstraint){for(var i=0;i<r.formulas.length;i++){var output=r.outputs[i],formula=r.formulas[i],inputs=formula.inputs,func=formula.func;this.formula(output,inputs,func)}return this}return Constraint.current.addPrimitiveConstraint(this),r}}),cop.create("PrintOMetaVariableAsBBBField").refineClass(users.timfelgentreff.jsinterpreter.Variable,{asJS:function(){var result=cop.proceed();return"(window.$$bbbVarMapping."+result+")"}}),DBConstraint.addMethods({isConstraintObject:!0,enable:function(priority){this.strength=priority||this.strength,this.addDBConstraint()},disable:function(){this.destroyDBConstraint()},cnOr:function(){return this}}),EqualityDBConstraint.addMethods({setExecuteFunction:function(func){var orig=this.execute.$originalFunction||this.execute;func.$originalFunction=orig,this.execute=func},unsetExecuteFunction:function(){this.execute=this.execute.$originalFunction||this.execute}})});