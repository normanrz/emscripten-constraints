module("users.timfelgentreff.sutherland.relax").requires().toRun(function(){function getRandomInt(min,max){return Math.floor(Math.random()*(max-min))+min}function Relax(){this.vars={},this.constraints=[],this.shouldRelax=!1}function RelaxNode(expr,vars,solver){this.expr=expr,this.vars=vars,this.errorFn=new Function("vars","return "+this.expr),this.solver=solver}Global.Relax=Relax,Relax.prototype.epsilon=.01,Relax.prototype.tinyDelta=1e-5,Relax.prototype.maxIterationsForOnePassMethodSolver=100,Relax.prototype.shortWaitMillis=20,Relax.prototype.mediumWaitMillis=100,Relax.prototype.longWaitMillis=1e3,Relax.prototype.changeVarValue=function(name,value){this.vars[name]=value;var tempConstraint=this.addConstraint(new RelaxNode('Math.abs(vars["'+name+'"] - '+value+")",[name],this),100);this.iterateForUpTo(this.mediumWaitMillis),this.removeConstraint(tempConstraint)},Relax.prototype.addVar=function(v,optValue){this.vars.hasOwnProperty(v)||(this.vars[v]=optValue||0)},Relax.prototype.removeVar=function(v){var self=this;delete this.vars[v],this.constraints.forEach(function(c){c.vars.indexOf(v)>=0&&self.removeConstraint(c)})},Relax.prototype.addConstraint=function(c){return this.constraints.push(c),this.constraintChanged(c),c},Relax.prototype.constraintChanged=function(c){var self=this;c.vars.forEach(function(v){self.addVar(v)})},Relax.prototype.removeConstraint=function(unwantedConstraint){this.constraints=this.constraints.filter(function(c){return c!==unwantedConstraint})},Relax.prototype.getError=function(optConstraints){var self=this;return(optConstraints||this.constraints).map(function(c){return c.errorFn(self.vars)}).reduce(function(e1,e2){return e1+e2},0)},Relax.prototype.derivative=function(c,v){function calcDerivative(x0,x1){self.vars[v]=x0;var y0=c.errorFn(self.vars);self.vars[v]=x1;var y1=c.errorFn(self.vars);return self.vars[v]=origValue,(y1-y0)/(x1-x0)}var self=this,origValue=this.vars[v],m=calcDerivative(origValue-this.tinyDelta,origValue+this.tinyDelta);return Math.abs(m)<this.tinyDelta&&(m=calcDerivative(origValue,origValue+this.tinyDelta)),Math.abs(m)<this.tinyDelta&&(m=calcDerivative(origValue-this.tinyDelta,origValue)),m},Relax.prototype.adjustVarForConstraint=function(v,c){for(var count=0;count++<this.maxIterationsForOnePassMethodSolver&&c.errorFn(this.vars)>this.epsilon;){var m=this.derivative(c,v),b=c.errorFn(this.vars)-m*this.vars[v],value=-b/m;if(!isFinite(value))break;this.vars[v]=value}return c.errorFn(this.vars)<=this.epsilon},Relax.prototype.adjustVarForConstraints=function(v,cs){var self=this,mbs=0,mms=0;cs.forEach(function(c){var m=self.derivative(c,v),b=c.errorFn(self.vars)-m*self.vars[v];mbs+=m*b,mms+=m*m});var newValue=-mbs/mms;isFinite(newValue)&&(self.vars[v]=newValue)},Relax.prototype.iterateForUpTo=function(tMillis){var didSomething,constraintsForRelaxation=this.constraints.slice(),computeStack=[],vars=Object.keys(this.vars);do didSomething=!1,vars.forEach(function(v){var theConstraint,numConstraintsFound=0;constraintsForRelaxation.forEach(function(c){c.vars.indexOf(v)>=0&&(theConstraint=c,numConstraintsFound++)}),1==numConstraintsFound&&theConstraint.vars.length>1&&(computeStack.push({variable:v,constraint:theConstraint}),constraintsForRelaxation=constraintsForRelaxation.filter(function(c){return c!==theConstraint}),didSomething=!0)});while(didSomething);vars={},constraintsForRelaxation.forEach(function(c){c.vars.forEach(function(v){vars[v]=!0})}),vars=Object.keys(vars);for(var t0=Date.now(),count=0;this.getError(constraintsForRelaxation)>this.epsilon&&Date.now()-t0<tMillis;)this.adjustVarForConstraints(vars[getRandomInt(0,vars.length)],constraintsForRelaxation),count++;for(;computeStack.length>0;){var entry=computeStack.pop();this.adjustVarForConstraint(entry.variable,entry.constraint)}var error=this.getError();return this.shouldRelax=error>this.epsilon,count},Global.RelaxNode=RelaxNode}),module("users.timfelgentreff.sutherland.relax_bbb").requires("users.timfelgentreff.sutherland.relax").toRun(function(){function _expr(o){return o instanceof RelaxNode?o.expr:o}Relax.prototype.always=function(opts,func){if(opts.priority)throw"soft constraints not implemented for Z3";func.varMapping=opts.ctx;var constraint=new Constraint(func,this);return this.addConstraint(constraint.constraintobjects[0]),this.solve(),constraint},Relax.prototype.constraintVariableFor=function(value,ivarname){if("number"==typeof value||null===value||value instanceof Number){var name=ivarname+":"+Strings.newUUID(),v=new RelaxNode('vars["'+name+'"]',[name],this);return this.addVar(name,value),v}return null},Relax.prototype.isConstraintObject=function(){return!0},Relax.prototype.solve=function(){if(this.iterateForUpTo(this.longWaitMillis),this.shouldRelax)throw new Error("Could not satisfy constraint")},Relax.prototype.weight=100,RelaxNode.prototype.isConstraintObject=function(){return!0},RelaxNode.prototype.isReadonly=function(){return!1},RelaxNode.prototype.setReadonly=function(){},RelaxNode.prototype.suggestValue=function(v){if(1!==this.vars.length)throw new Error("Inconsistent RelaxNode");return this.solver.changeVarValue(this.vars[0],v)},RelaxNode.prototype.value=function(){return this.solver.vars[this.vars[0]]},RelaxNode.prototype.cnEquals=function(r){return new RelaxNode("Math.abs("+this.expr+" - ("+_expr(r)+"))",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.cnIdentical=RelaxNode.prototype.cnEquals,RelaxNode.prototype.cnGeq=function(r){return new RelaxNode("(("+this.expr+" >= "+_expr(r)+") ? 0 : Math.abs("+this.expr+" - ("+_expr(r)+")))",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.cnLeq=function(r){return new RelaxNode("(("+this.expr+" <= "+_expr(r)+") ? 0 : Math.abs("+this.expr+" - ("+_expr(r)+")))",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.cnLess=function(r){return new RelaxNode("(("+this.expr+" < "+_expr(r)+") ? 0 : (("+this.expr+" + ("+_expr(r)+" * "+this.solver.epsilon+")) - ("+_expr(r)+")))",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.cnGreater=function(r){return new RelaxNode("(("+this.expr+" > "+_expr(r)+") ? 0 : (("+_expr(r)+" + ("+_expr(r)+" * "+this.solver.epsilon+")) - ("+this.expr+")))",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.cnNeq=function(r){return new RelaxNode("((Math.abs("+this.expr+" - "+_expr(r)+") > "+this.solver.epsilon+") ? 0 : Math.abs(("+_expr(r)+" + ("+_expr(r)+" * "+this.solver.epsilon+")) - ("+this.expr+")))",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.cnNotIdentical=RelaxNode.prototype.cnNeq,RelaxNode.prototype.plus=function(r){return new RelaxNode("("+this.expr+" + "+_expr(r)+")",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.minus=function(r){return new RelaxNode("("+this.expr+" - "+_expr(r)+")",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.times=function(r){return new RelaxNode("("+this.expr+" * "+_expr(r)+")",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.divide=function(r){return new RelaxNode("("+this.expr+" / "+_expr(r)+")",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.modulo=function(r){return new RelaxNode("("+this.expr+" % "+_expr(r)+")",this.vars.concat(r.vars).uniq(),this.solver)},RelaxNode.prototype.pow=function(r){return new RelaxNode("Math.pow("+this.expr+", "+_expr(r)+")",this.vars,this.solver)},RelaxNode.prototype.sin=function(){return new RelaxNode("Math.sin("+this.expr+")",this.vars,this.solver)},RelaxNode.prototype.cos=function(){return new RelaxNode("Math.cos("+this.expr+")",this.vars,this.solver)},RelaxNode.prototype.tan=function(){return new RelaxNode("Math.tan("+this.expr+")",this.vars,this.solver)},RelaxNode.prototype.cnOr=function(){return this},RelaxNode.prototype.enable=function(){},RelaxNode.prototype.disable=function(){}});